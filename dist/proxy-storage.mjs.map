{"version":3,"sources":["../src/proxy-storage.ts"],"sourcesContent":["import { proxy, subscribe } from \"valtio\";\r\n\r\ntype ProxyValidKey = string;\r\n\r\nexport interface PersistedClient<T extends object> {\r\n  timestamp: number;\r\n  version: number;\r\n  clientState?: T;\r\n}\r\n\r\ninterface Persister<T extends object> {\r\n  persistClient: (persistClient: PersistedClient<T>) => void;\r\n  restoreClient: () => PersistedClient<T> | undefined;\r\n  removeClient: () => void;\r\n}\r\n\r\ninterface ProxyPersistClientRestore<T extends object> {\r\n  maxAge?: number;\r\n  version?: number;\r\n  persister?: Persister<T>;\r\n}\r\n\r\ninterface ProxyPersistClientSave<T extends object> {\r\n  version?: number;\r\n  clientState?: T;\r\n  persister?: Persister<T>;\r\n}\r\n\r\ninterface Storage {\r\n  getItem: (key: string) => string | null;\r\n  setItem: (key: string, value: string) => void;\r\n  removeItem: (key: string) => void;\r\n}\r\n\r\nexport interface CreateStoragePersisterOptions<T extends object> {\r\n  /** The storage client used for setting and retrieving items from cache.\r\n   * For SSR pass in `undefined`. Note that window.localStorage can be\r\n   * `null` in Android WebViews depending on how they are configured.\r\n   * @default `localStorage`\r\n   */\r\n  storage?: Storage;\r\n  /** The key to use when storing the cache */\r\n  key: ProxyValidKey;\r\n  /** To avoid spamming,\r\n   * pass a time in ms to throttle saving the cache to disk */\r\n  throttleTime?: number;\r\n  /**\r\n   * How to serialize the data to storage.\r\n   * @default `JSON.stringify`\r\n   */\r\n  serialize?: (persistedQuery?: PersistedClient<T>) => string;\r\n  /**\r\n   * How to deserialize the data from storage.\r\n   * @default `JSON.parse`\r\n   */\r\n  deserialize?: (cachedString: string) => PersistedClient<T>;\r\n}\r\n\r\nexport interface ProxyWithStorageOptions<T extends object>\r\n  extends CreateStoragePersisterOptions<T>,\r\n    ProxyPersistClientRestore<T>,\r\n    Omit<ProxyPersistClientSave<T>, \"clientState\"> {}\r\n\r\nexport function createProxyStoragePersister<T extends object>({\r\n  storage,\r\n  key = \"PROXY_OFFLINE_CACHE\",\r\n  throttleTime = 1000,\r\n  serialize = JSON.stringify,\r\n  deserialize = JSON.parse,\r\n}: CreateStoragePersisterOptions<T>): Persister<T> {\r\n  if (storage) {\r\n    const trySave = (\r\n      persistedClient: PersistedClient<T>\r\n    ): Error | undefined => {\r\n      try {\r\n        storage.setItem(key, serialize(persistedClient));\r\n        return;\r\n      } catch (error) {\r\n        return error as Error;\r\n      }\r\n    };\r\n    return {\r\n      persistClient: throttle((persistedClient) => {\r\n        const client: PersistedClient<T> | undefined = persistedClient;\r\n        trySave(client);\r\n      }, throttleTime),\r\n      restoreClient: () => {\r\n        const cacheString = storage.getItem(key);\r\n\r\n        if (!cacheString) {\r\n          return;\r\n        }\r\n\r\n        return deserialize(cacheString);\r\n      },\r\n      removeClient: () => {\r\n        storage.removeItem(key);\r\n      },\r\n    };\r\n  }\r\n\r\n  return {\r\n    persistClient: noop,\r\n    restoreClient: () => undefined,\r\n    removeClient: noop,\r\n  };\r\n}\r\n\r\nfunction proxyPersistClientRestore<T extends object>({\r\n  maxAge = 1000 * 60 * 60 * 24,\r\n  version = 0,\r\n  persister,\r\n}: ProxyPersistClientRestore<T>) {\r\n  try {\r\n    const persistedClient = persister?.restoreClient();\r\n\r\n    if (persistedClient) {\r\n      if (persistedClient.timestamp) {\r\n        const expired = Date.now() - persistedClient.timestamp > maxAge;\r\n\r\n        if (expired || persistedClient.version !== version) {\r\n          persister?.removeClient();\r\n        } else {\r\n          return persistedClient.clientState;\r\n        }\r\n      } else {\r\n        persister?.removeClient();\r\n      }\r\n    }\r\n  } catch (error) {\r\n    if (process.env.NODE_ENV !== \"production\") {\r\n      console.error(error);\r\n    }\r\n    persister?.removeClient();\r\n  }\r\n}\r\n\r\nfunction proxyPersistClientSave<T extends object>({\r\n  clientState,\r\n  version = 0,\r\n  persister,\r\n}: ProxyPersistClientSave<T>) {\r\n  const persistedClient: PersistedClient<T> = {\r\n    timestamp: Date.now(),\r\n    version,\r\n    clientState,\r\n  };\r\n\r\n  persister?.persistClient(persistedClient);\r\n}\r\n\r\nexport function proxyWithStorage<T extends object>(\r\n  initialObject: T,\r\n  {\r\n    key,\r\n    maxAge,\r\n    version,\r\n    throttleTime,\r\n    deserialize,\r\n    serialize,\r\n    storage = typeof window !== \"undefined\" ? localStorage : undefined,\r\n    persister = createProxyStoragePersister<T>({\r\n      key,\r\n      throttleTime,\r\n      deserialize,\r\n      serialize,\r\n      storage,\r\n    }),\r\n  }: ProxyWithStorageOptions<T>\r\n): T & { persister?: Persister<T> } {\r\n  const clientState = proxy<T & { persister?: Persister<T> }>(\r\n    Object.assign(\r\n      {},\r\n      initialObject,\r\n      proxyPersistClientRestore<T>({ persister, version, maxAge }) || {}\r\n    )\r\n  );\r\n\r\n  clientState.persister = persister;\r\n\r\n  subscribe(clientState, () => {\r\n    proxyPersistClientSave<T>({ clientState, persister, version });\r\n  });\r\n\r\n  return clientState;\r\n}\r\n\r\nfunction noop() {}\r\n\r\nfunction throttle<TArgs extends Array<any>>(\r\n  func: (...args: TArgs) => any,\r\n  wait = 100\r\n) {\r\n  let timer: ReturnType<typeof setTimeout> | null = null;\r\n  let params: TArgs;\r\n  return function (...args: TArgs) {\r\n    params = args;\r\n    if (timer === null) {\r\n      timer = setTimeout(() => {\r\n        func(...params);\r\n        timer = null;\r\n      }, wait);\r\n    }\r\n  };\r\n}\r\n"],"mappings":";AAAA,SAAS,OAAO,iBAAiB;AA+D1B,SAAS,4BAA8C;AAAA,EAC5D;AAAA,EACA,MAAM;AAAA,EACN,eAAe;AAAA,EACf,YAAY,KAAK;AAAA,EACjB,cAAc,KAAK;AACrB,GAAmD;AACjD,MAAI,SAAS;AACX,UAAM,UAAU,CACd,oBACsB;AACtB,UAAI;AACF,gBAAQ,QAAQ,KAAK,UAAU,eAAe,CAAC;AAC/C;AAAA,MACF,SAAS,OAAP;AACA,eAAO;AAAA,MACT;AAAA,IACF;AACA,WAAO;AAAA,MACL,eAAe,SAAS,CAAC,oBAAoB;AAC3C,cAAM,SAAyC;AAC/C,gBAAQ,MAAM;AAAA,MAChB,GAAG,YAAY;AAAA,MACf,eAAe,MAAM;AACnB,cAAM,cAAc,QAAQ,QAAQ,GAAG;AAEvC,YAAI,CAAC,aAAa;AAChB;AAAA,QACF;AAEA,eAAO,YAAY,WAAW;AAAA,MAChC;AAAA,MACA,cAAc,MAAM;AAClB,gBAAQ,WAAW,GAAG;AAAA,MACxB;AAAA,IACF;AAAA,EACF;AAEA,SAAO;AAAA,IACL,eAAe;AAAA,IACf,eAAe,MAAM;AAAA,IACrB,cAAc;AAAA,EAChB;AACF;AAEA,SAAS,0BAA4C;AAAA,EACnD,SAAS,MAAO,KAAK,KAAK;AAAA,EAC1B,UAAU;AAAA,EACV;AACF,GAAiC;AAC/B,MAAI;AACF,UAAM,kBAAkB,WAAW,cAAc;AAEjD,QAAI,iBAAiB;AACnB,UAAI,gBAAgB,WAAW;AAC7B,cAAM,UAAU,KAAK,IAAI,IAAI,gBAAgB,YAAY;AAEzD,YAAI,WAAW,gBAAgB,YAAY,SAAS;AAClD,qBAAW,aAAa;AAAA,QAC1B,OAAO;AACL,iBAAO,gBAAgB;AAAA,QACzB;AAAA,MACF,OAAO;AACL,mBAAW,aAAa;AAAA,MAC1B;AAAA,IACF;AAAA,EACF,SAAS,OAAP;AACA,QAAI,QAAQ,IAAI,aAAa,cAAc;AACzC,cAAQ,MAAM,KAAK;AAAA,IACrB;AACA,eAAW,aAAa;AAAA,EAC1B;AACF;AAEA,SAAS,uBAAyC;AAAA,EAChD;AAAA,EACA,UAAU;AAAA,EACV;AACF,GAA8B;AAC5B,QAAM,kBAAsC;AAAA,IAC1C,WAAW,KAAK,IAAI;AAAA,IACpB;AAAA,IACA;AAAA,EACF;AAEA,aAAW,cAAc,eAAe;AAC1C;AAEO,SAAS,iBACd,eACA;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,UAAU,OAAO,WAAW,cAAc,eAAe;AAAA,EACzD,YAAY,4BAA+B;AAAA,IACzC;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,CAAC;AACH,GACkC;AAClC,QAAM,cAAc;AAAA,IAClB,OAAO;AAAA,MACL,CAAC;AAAA,MACD;AAAA,MACA,0BAA6B,EAAE,WAAW,SAAS,OAAO,CAAC,KAAK,CAAC;AAAA,IACnE;AAAA,EACF;AAEA,cAAY,YAAY;AAExB,YAAU,aAAa,MAAM;AAC3B,2BAA0B,EAAE,aAAa,WAAW,QAAQ,CAAC;AAAA,EAC/D,CAAC;AAED,SAAO;AACT;AAEA,SAAS,OAAO;AAAC;AAEjB,SAAS,SACP,MACA,OAAO,KACP;AACA,MAAI,QAA8C;AAClD,MAAI;AACJ,SAAO,YAAa,MAAa;AAC/B,aAAS;AACT,QAAI,UAAU,MAAM;AAClB,cAAQ,WAAW,MAAM;AACvB,aAAK,GAAG,MAAM;AACd,gBAAQ;AAAA,MACV,GAAG,IAAI;AAAA,IACT;AAAA,EACF;AACF;","names":[]}